######################################
##      USER DEFINED PARAMETERS     ##
######################################

$startDate = [DateTime]"2024-02-01"
$endDate = [DateTime]"2024-11-21 17:20:17"
$pesRegion = "na"
$backfillDir = "V:\DMS_Data04\pes_backfill\na"
$batchSize = 10000
$backfillTargets = @(
    @{
        CdmsInstance = "NY5PCDMSDB12"
        CustId = 373
        CampIds = "32208,29248,30909,30330,29085,38373,30325,30643,30321,42527,30684,28796,29016,30912,42524,42530,30688,30649,28982,30639,35447,30641"
    },
    @{
        CdmsInstance = "NY5PCDMSDB04"
        CustId = 543
        CampIds = "5611,8183,17067,17090,17091,17092,17093,17094,17095,17096,17098,17099,17100,17101,17102,17103,17104,17139,17140,17274,17541,17542,17543,17813,17814,17817,17820,18279,19030,19032,19033,19237,23161,23231,25897,26297,26298,27808,28522,29602,31943,32185,32607,34894,39021,40159,43134,46532,47073,55102,56444,56533,56538,57211,61589,63080,67044,67083,67084,67593,71850,71851,73966,74288,77608,85811,87097,91565,91566,91567,93470,93723,97288,105412,112531,112831,112832,115863,116378,116752,119025,119072,119463,122545,123491,124031,124036,124038,128643,129730,129923,129927,130127,132076,134019,135746,137259,137260,141845,143045,143054,144160,145227,145351,145353,145654,145910,146231,147279,149523,153520,153521,153641,153642,155306,155728,155746,155958,157684,158524,158525,165368,169371,170307,172321,172346,173779,182180,188877,188881,188883,188886,191683,191744,193680,197723,199754,199756,199807,204677,204694,204702,210167,210245,210246,210259,210328,210330,210520,213821,214776,224835,224837,227450,229856,229869,229881,230021,230640,231904,233083,239396,240062,240094,241000,241157,241279,244299,244593,246184,247816,248530,249033,254333,258009,258010,258442,258901,258902,258905,258916,258925,258933,259985,260624,262998,271192,274573,279883,282742,283608,286042,286071,287948,287953,287956,287980,288027,289569,289886,297237,298967,298968,300445,302649,305496,305505,305506,305508,305755,307429,307712,309953,310523,314437,315553,315554,315555,315598,315771,315775,318517,318914,318939,320260,321351,323043,325717,326489,326504,326597,327470,329957,331480,332202,334310,334368,334475,341285,341286,341287,341288,341291,341292,341293,341294,341310,341311,341312,341313,341326,341327,341328,341329,341609,342291,342293,342299,342331,342335,344162,344163,344523,345027,345435,345938,345941,346878,346879,347051,347169,347562,347563,350826,351586,355159,356950,358086,365603,366201,366521,367067,367068,367069,367070,367071,367936,370660,371928,371929,371930,371931,371932,371933,371934,376500,377083,379900,380302,381715,383989,384182,387569,387588,388505,389725,390472,391090,391241,392239,392309,392399,393135,393755,393852,396866,396906,397612,398612,402679,402924,404746,404749,404750,405553,406082,406084,406086,406816,407987,408637,409727,410034,410449,411516,411517,411518,411519,411525,411526,411527,411528,412725,413363,413375,413384,414431,414440,414452,415455,416433,417008,418344,419789,419790,419792,419793,420935,422937,423802,425514,426045,426691,426692,426963,426967,427369,427818,428097,428733,428820,428919,429579,429614,430287,430288,430615,431453,431454,431617,432452,433294,441989,442376,442671"
    },
    @{
        CdmsInstance = "NY5PCDMSDB26"
        CustId = 997
        CampIds = "4991,5038,4993,5002,5000,4996,5040,4998,5042"
    },
    @{
        CdmsInstance = "NY5PCDMSDB24"
        CustId = 1021
        CampIds = "84834,23395,57100,37592,49698,60342,63885,50112,42942,46015,50909,89366,43963,47791,46999,36164,52108,66528,8488,18498,12162,32518,83108,48989,6207,7496,40926,34998,43411,68533,27347,33164,36619,31997,21504,23992,5591,11628,56410,26533,77817,44434,44884,20369,63449,80786,15822,30857,33655,75344,45644,60145,28883,28115,37130,25610,57615,35659,79546,38907,73866,39835,58421,54815,46549,41605,34481,10596,39380,90578,65036,54110,64919,41836,14848,22676,13618,58848,9605,48650,34668,38175,8768,40489,103424,183217,6300,6299,183218,15709,219607,129429,127939"
    },
    @{
        CdmsInstance = "NY5PCDMSDB13"
        CustId = 1184
        CampIds = "2870"
    },
    @{
        CdmsInstance = "NY5PCDMSDB17"
        CustId = 684
        CampIds = "1094,1117,1286,1314,1351,1352,1353,1361,1362,1386,1387,1393,1394,1404,1405,1417,1432,1464,1481,1492,1521,1526,1527,1576,1582,1583,1602,1622,1656,1657,1658,1659,1708,1709,1710,1711,1733,1734,1735,1769,1770,1771,1804,1805,1910,2032,2033,2078,2079,2083,2084,2085,2092,2093,2108,2109,2123,2138,2153,2154,2171,2172,2234,2235,2237,2238,2302,2303,2305,2306,2316,2332,2333,2371,2372,2374,2375,2396,2398,2399,2436,2437,2445,2511,2512,2513,2537,2538,2539,2540,2581,2582,2583,2596,2655,2656,2658,2659,2748,2749,2751,2752,2753,2786,2788,2789,2810,2811,2859,2860,2862,2896,2904,2905,2942,2943,2944,2959,3003,3004,3006,3037,3038,3039,3083,3084,3086,3087,3109,3110,3112,3113,3160,3161,3163,3226,3239,3240,3288,3294,3295,3296,3298,3336,3338,3389,3404,3405,3418,3423,3457,3458,3459,3534,3535,3537,3538,3651,3654,3716,3717,3822,3823,3884,3885,3978,3990,3991,3995,3998,3999,4091,4092,4158,4159,4176,4177,4205,4206,4219,4236,4237,4240,4248,4260,4299,4301,4302,4315,4316,4326,4351,4354,4355,4357,4360,4361,4372,4373,4412,4413,4425,4457,4458,4460,4461,4462,4463,4465,4466,4468,4470,4471,4472,4473,4475,4477,4478,4479,4480,4481,4503,4561,4562,4563,4564,4682,4683,4685,4686,4692,4693,4742,4743,4744,4745,4818,4819,4915,4916,4920,4922,5002,5003,5142,5219,5220,5238,5284,5286,5380,5398,5399,5400,5401,5402,5403,5420,5421,5485,5486,5488,5489,5492,5527,5528,5548,5587,5588,5590,5591,5633,5634,5636,5643,5655,5656,5714,5716,5730,5734,5735,5739,5740,5780,5832,5833,5860,5869,5870,5888,5889,5968,5969,5971,5972,6002,6006,6007,6017,6047,6048,6057,6058,6068,6069,6077,6078,6093,6094,6111,6112,6127,6128,6136,6152,6153,6193,6233,6234,6235,6263,6266,6287,6288,6293,6327,6328,6330,6331,6385,6386,6451,6452,6463,6467,6522,6523,6525,6526,6543,6544,6561,6562,6577,6615,6616,6618,6619,6675,6676,6685,6686,6695,6696,6697,6698,6758,6760,6822,6824,6837,6838,6863,6864,6885,6899,6929,6933,6961,6962,6963,6977,6978,7008,7009,7021,7022,7084,7085,7112,7113,7123,7124,7136,7141,7142,7184,7185,7193,7194,7197,7212,7213,7250,7251,7259,7297,7298,7308,7320,7336,7337,7352,7367,7368,7369,7378,7379,7406,7408,7409,7410,7429,7430,7448,7449,7486,7487,7496,7514,7515,7521,7522,7539,7540,7556,7584,7598,7615,7643,7644,7645,7681,7682,7696,7697,7700,7701,7727,7728,7730,7731,7772,7781,7820,7821,7837,7838,7887,7889,7890,7891,7893,7894,7896,7940,7969,7970,7979,7980,7982,7983,7985,7989,8015,8016,8018,8019,8053,8056,8057,8090,8091,8098,8099,8124,8132,8133,8223,8224,8235,8236,8256,8257,8259,8260,8266,8267,8269,8270,8284,8286,8304,8306,8307,8308,8312,8313,8315,8330,8331,8364,8365,8373,8374,8381,8382,8395,8417,8418,8491,8492,8504,8505,8559,8561,8600,8601,8603,8604,8623,8686,8705,8706,8708,8709,8742,8743,8754,8755,8757,8758,8804,8812,8813,8850,8851,8852,8861,8863,8864,8893,8894,8909,8910,8912,8913,8948,8949,8950,8966,8967,8999,9005,9006,9017,9018,9048,9049,9050,9071,9072,9097,9098,9133,9134,9135,9150,9187,9188,9202,9203,9205,9206,9229,9255,9256,9258,9259,9271,9293,9294,9323,9324,9325,9332,9379,9380,9381,9382,9386,9419,9437,9438,9456,9476,9477,9479,9495,9496,9513,9514,9537,9538,9539,9540,9565,9566,9597,9598,9599,9600,9601,9602,9610,9611,9629,9643,9644,9670,9672,9684,9685,9686,9688,9707,9724,9725,9760,9761,9770,9771,9782,9783,9846,9847,9871,9872,9917,9918,9933,9934,9935,9936,9958,9959,9960,9961,9987,9988,9989,9990,9997,10008,10009,10010,10071,10078,10079,10082,10083,10084,10156,10157,10162,10163,10167,10168,10179,10180,10207,10208,10265,10266,10304,10318,10319,10342,10382,10383,10384,10416,10417,10420,10421,10428,10429,10463,10464,10508,10509,10546,10547,10551,10573,10574,10600,10601,10645,10662,10663,10664,10674,10675,10691,10692,10707,10708,10737,10738,10739,10744,10761,10762,10786,10787,10788,10789,10795,10838,10839,10842,10844,10879,10880,10895,10896,10897,10923,10924,10961,10962,10963,10977,10978,10992,10993,11026,11027,11036,11094,11099,11100,11101,11102,11103,11104,11113,11114,11115,11141,11142,11150,11160,11161,11191,11192,11196,11197,11198,11213,11214,11244,11245,11246,11253,11254,11273,11274,11279,11280,11287,11288,11324,11325,11355,11356,11370,11372,11380,11424,11425,11426,11478,11479,11495,11496,11515,11528,11548,11549,11562,11563,11573,11574,11608,11609,11611,11612,11645,11646,11655,11673,11687,11688,11704,11705,11706,11707,11717,11740,11741,11772,11773,11775,11776,11777,11778,11815,11820,11821,11823,11865,11866,11903,11907,11908,11915,11916,11923,11924,11945,11969,11970,12040,12045,12046,12048,12049,12054,12055,12067,12079,12080,12102,12103,12109,12110,12128,12129,12203,12204,12208,12209,12213,12214,12223,12224,12246,12247,12274,12276,12277,12316,12325,12326,12327,12330,12331,12382,12383,12419,12420,12421,12425,12491,12492,12493,12494,12495,12571,12572,12573,12595,12596,12597,12598,12635,12636,12637,12652,12653,12654,12706,12707,12717,12747,12748,12749,12753,12754,12765,12805,12819,12820,12825,12826,12843,12844,12854,12877,12878,12916,12917,12918,12919,12974,12975,12976,12977,13020,13030,13031,13076,13077,13080,13081,13116,13117,13167,13168,13169,13170,13183,13184,13186,13187,13206,13218,13247,13248,13273,13274,13316,13317,13333,13334,13368,13370,13408,13409,13410,13442,13448,13469,13470,13474,13532,13533,13573,13574,13575,13576,13640,13641,13665,13668,13669,13670,13672,13673,13674,13675,13676,13677,13749,13750,13769,13770,13778,13779,13841,13842,13868,13875,13885,13886,13935,13936,13966,13967,13972,13973,14037,14038,14072,14081,14082,14159"
    },
    @{
        CdmsInstance = "NY5PCDMSDB17"
        CustId = 684
        CampIds = "14160,14305,14306,14307,14308,14309,14310,14313,14314,14315,14316,14318,14321,14326,14340,14341,14373,14374,14375,14399,14419,14420,14432,14446,14447,14562,14563,14564,14565,14566,14567,14568,14569,14571,14603,14604,14606,14610,14612,14693,14694,14695,14697,14702,14705,14706,14707,14708,14709,14711,14712,14713,14715,14831,14833,14835,14836,14840,14858,14859,14860,14861,14862,14879,14880,14881,14882,14886,14888,14917,14918,14940,14974,14975,15009,15010,15024,15026,15027,15028,15030,15044,15091,15109,15110,15172,15173,15213,15214,15241,15242,15299,15300,15369,15371,15372,15373,15375,15406,15407,15418,15458,15459,15488,15489,15531,15533,15534,15535,15537,15576,15577,15578,15579,15580,15582,15583,15584,15585,15586,15612,15613,15637,15639,15640,15641,15642,15643,15682,15684,15685,15686,15688,15692,15693,15694,15695,15696,15698,15699,15700,15701,15702,15752,15753,15754,15756,15757,15759,15779,15780,15887,15922,15932,15933,15967,15968,15975,15976,16023,16024,16076,16077,16078,16079,16085,16086,16091,16130,16156,16158,16159,16160,16161,16162,16245,16268,16269,16280,16281,16292,16294,16295,16318,16319,16324,16364,16365,16386,16387,16447,16455,16456,16549,16606,16607,16634,16636,16637,16638,16640,16655,16675,16677,16678,16679,16681,16736,16737,16797,16802,16803,16804,16806,16835,16836,16869,16870,16892,16893,16994,17047,17048,17053,17060,17061,17077,17086,17088,17123,17124,17161,17162,17175,17176,17251,17253,17254,17255,17257,17266,17281,17282,17283,17285,17324,17327,17357,17358,17362,17363,17401,17402,17403,17438,17439,17459,17460,17488,17489,17523,17538,17539,17544,17545,17551,17552,17627,17628,17682,17683,17694,17750,17751,17772,17794,17795,17798,17826,17827,17837,17870,17871,17872,17873,17874,17875,17905,17948,17951,17952,18000,18001,18002,18030,18031,18039,18060,18061,18077,18098,18099,18123,18124,18132,18171,18172,18176,18178,18179,18215,18216,18217,18231,18270,18276,18302,18303,18343,18383,18384,18390,18391,18503,18504,18505,18554,18555,18556,18557,18558,18565,18616,18617,18621,18622,18624,18625,18626,18660,18719,18720,18773,18774,18787,18788,18789,18824,18825,18848,18849,18877,18915,18916,18917,18927,18928,18966,18967,18968,18969,18999,19000,19040,19041,19107,19108,19110,19111,19127,19128,19175,19191,19192,19217,19239,19240,19286,19287,19325,19327,19328,19344,19352,19353,19378,19412,19413,19429,19430,19432,19456,19476,19477,19479,19510,19511,19518,19519,19544,19545,19546,19556,19568,19569,19607,19608,19641,19643,19652,19653,19678,19679,19702,19752,19753,19754,19755,19756,19757,19758,19759,19760,19777,19778,19823,19860,19861,19862,19919,19920,19935,19936,19945,19946,19957,19958,19974,20003,20004,20028,20029,20056,20057,20139,20140,20141,20142,20172,20173,20174,20255,20256,20283,20291,20292,20308,20323,20324,20350,20351,20413,20414,20457,20469,20470,20473,20474,20489,20490,20503,20508,20522,20525,20526,20550,20551,20556,20557,20578,20579,20612,20613,20638,20639,20655,20656,20672,20673,20674,20675,20697,20698,20705,20722,20723,20729,20730,20743,20744,20768,20769,20770,20771,20795,20796,20805,20831,20844,20845,20852,20886,20896,20897,20918,20919,20946,20953,20954,20994,20995,21004,21026,21027,21049,21050,21071,21072,21112,21125,21137,21138,21146,21147,21148,21149,21191,21192,21214,21215,21240,21241,21263,21277,21278,21293,21296,21298,21315,21343,21368,21369,21379,21387,21413,21434,21435,21436,21458,21459,21489,21490,21505,21510,21547,21548,21554,21555,21606,21607,21612,21613,21665,21666,21683,21684,21700,21711,21712,21736,21737,21770,21771,21799,21826,21827,21836,21853,21856,21857,21895,21896,21897,21910,21932,21935,21942,21943,21957,21958,21978,22001,22002,22035,22047,22048,22049,22070,22071,22108,22109,22126,22187,22188,22193,22194,22239,22240,22244,22282,22283,22292,22293,22373,22374,22401,22402,22403,22429,22450,22451,22454,22455,22456,22457,22458,22510,22511,22523,22524,22550,22551,22564,22641,22656,22683,22689,22690,22717,22718,22720,22740,22750,22751,22779,22780,22783,22802,22803,22838,22839,22859,22868,22869,22893,22894,22895,22926,22937,22940,23005,23006,23013,23014,23037,23038,23073,23074,23075,23106,23107,23110,23111,23142,23143,23165,23188,23195,23196,23238,23239,23258,23297,23302,23303,23323,23324,23375,23402,23403,23404,23438,23446,23448,23449,23450,23500,23501,23504,23516,23517,23520,23528,23529,23531,23532,23574,23576,23577,23591,23592,23647,23649,23651,23654,23655,23695,23696,23698,23700,23701,23722,23723,23724,23725,23767,23768,23769,23822,23823,23824,23825,23829,23830,23831,23852,23864,23865,23867,23868,23905,23906,23907,23908,23926,23927,23929,23930,23958,23959,23960,23961,23977,24024,24025,24027,24030,24031,24032,24033,24081,24082,24093,24094,24095,24096,24097,24107,24108,24109,24150,24151,24152,24153,24174,24175,24210,24211,24213,24214,24222,24223,24268,24269,24270,24271,24313,24315,24316,24317,24332,24333,24335,24336,24363,24364,24365,24366,24383,24384,24385,24386,24434,24435,24436,24437,24470,24471,24473,24478,24479,24480,24521,24522,24524,24561,24562,24564,24565,24569,24580,24648,24649,24650,24666,24705,24706,24707,24708,24711,24712,24714,24770,24771,24772,24773,24792,24793,24794,24795,24797,24798,24827,24828,24829,24830,24847,24848,24849,24850,24883,24884,24885,24886,24903,24904,24905,24954,24955,24957,24958,24968,24995,24996,24997,24998,25037,25038,25039,25040,25098,25099,25101,25102,25146,25148,25149,25163,25203,25204,25205,25228,25229,25274,25275,25278,25288,25289,25310,25311,25327,25350,25362,25373,25374,25392,25393,25394,25433,25442,25443,25447,25448,25488,25489,25490,25507,25508,25513,25514,25520,25557,25558,25570,25592,25593,25596,25614,25615,25616,25630,25631,25643,25659,25684,25685,25731,25734,25785,25786,25789,25790,25806,25807,25851,25896,25897,25999,26032,26078,26085,26132,26133,26159,26186,26262,26264,26265,26310,26315,26316,26317,26318,26336,26337,26352,26361,26362,26388,26389,26402,26410,26453,26478,26479,26499,26505,26506,26525,26536,26546,26547,26569,26584,26585,26600,26614,26615,26621,26632,26650,26659,26664,26741,26742,26756,26763,26764,26776,26788"
    },
    @{
        CdmsInstance = "NY5PCDMSDB17"
        CustId = 684
        CampIds = "26807,26808,26814,26875,26876,26879,26955,26956,26957,26958,26993,27053,27054,27055,27059,27060,27063,27100,27131,27132,27185,27186,27213,27221,27222,27225,27226,27327,27328,27338,27362,27363,27389,27390,27431,27451,27476,27484,27485,27505,27506,27517,27523,27526,27535,27563,27564,27586,27587,27621,27643,27645,27701,27734,27753,27754,27775,27776,27786,27811,27812,27854,27855,27857,27900,27901,27912,27931,27932,27941,27979,27980,27991,27992,28003,28004,28005,28008,28009,28024,28092,28111,28112,28140,28145,28170,28171,28180,28181,28237,28240,28243,28244,28263,28264,28277,28278,28295,28296,28311,28315,28343,28349,28352,28353,28368,28369,28375,28384,28395,28396,28412,28427,28459,28505,28507,28508,28548,28569,28570,28572,28600,28601,28616,28617,28667,28668,28694,28695,28710,28726,28727,28782,28786,28789,28790,28791,28827,28862,28864,28895,28896,28898,28913,28927,28931,28952,28958,28959,28960,28981,28982,28999,29033,29054,29055,29071,29084,29085,29099,29100,29101,29134,29141,29142,29164,29165,29185,29188,29189,29210,29218,29223,29247,29248,29278,29279,29305,29306,29338,29356,29357,29360,29361,29386,29393,29396,29398,29416,29417,29424,29425,29451,29452,29462,29463,29467,29514,29515,29538,29539,29562,29563,29570,29575,29597,29598,29616,29623,29642,29643,29672,29673,29675,29685,29711,29714,29750,29759,29760,29761,29766,29767,29789,29815,29816,29817,29828,29839,29850,29851,29896,29909,29929,29930,29932,29933,29935,29945,29964,29981,30004,30008,30011,30038,30039,30074,30075,30090,30091,30093,30101,30118,30124,30137,30147,30148,30203,30204,30205,30206,30217,30221,30222,30227,30240,30264,30273,30282,30283,30343,30344,30348,30349,30376,30377,30400,30404,30406,30436,30442,30448,30450,30451,30488,30489,30506,30512,30519,30528,30544,30561,30573,30600,30601,30602,30603,30647,30658,30659,30660,30661,30677,30678,30679,30680,30701,30710,30719,30720,30721,30732,30733,30735,30758,30769,30770,30784,30790,30809,30830,30878,30880,30881,30911,30912,30913,30914,30932,30933,30941,30950,30977,30981,30993,30994,31012,31013,31016,31101,31102,31103,31104,31113,31114,31116,31117,31118,31119,31120,31121,31192,31193,31210,31211,31222,31223,31234,31235,31253,31266,31267,31279,31293,31294,31301,31316,31325,31340,31364,31365,31384,31385,31394,31395,31398,31399,31521,31523,31525,31526,31530,31536,31565,31577,31578,31579,31599,31600,31621,31629,31642,31643,31650,31651,31663,31664,31675,31678,31679,31702,31716,31717,31777,31778,31800,31854,31855,31857,31858,31906,31919,31920,31932,31940,31941,31942,31963,31969,31986,31987,32070,32071,32077,32079,32094,32095,32103,32119,32120,32125,32136,32140,32143,32157,32158,32160,32167,32240,32241,32255,32261,32264,32275,32276,32281,32304,32374,32375,32378,32388,32401,32402,32424,32425,32455,32456,32457,32465,32494,32501,32513,32514,32522,32539,32540,32556,32569,32587,32700,32701,32772,32773,32774,32781,32788,32789,32810,32814,32815,32819,32839,32840,32858,32859,32877,32879,32883,32895,32896,32925,32927,32930,32938,32960,32961,32963,32975,32976,32989,33008,33009,33011,33035,33036,33037,33055,33090,33092,33093,33108,33109,33128,33131,33142,33143,33145,33152,33159,33175,33176,33191,33194,33195,33321,33322,33323,33342,33349,33365,33366,33389,33400,33423,33424,33435,33447,33464,33477,33478,33487,33493,33507,33521,33559,33560,33564,33570,33571,33586,33592,33597,33605,33606,33623,33643,33660,33666,33667,33668,33700,33705,33723,33738,33750,33751,33752,33765,33791,33806,33823,33836,33837,33846,33847,33865,33910,33924,33925,33945,33946,33965,33983,33984,34002,34007,34015,34038,34039,34040,34052,34079,34086,34087,34099,34147,34165,34171,34172,34212,34213,34229,34231,34241,34242,34243,34246,34262,34269,34270,34283,34309,34310,34332,34334,34377,34381,34385,34386,34435,34449,34455,34469,34470,34487,34488,34504,34535,34544,34554,34561,34585,34587,34588,34595,34596,34604,34605,34625,34626,34636,34667,34784,34785,34786,34789,34790,34806,34807,34824,34825,34837,34850,34854,34862,34863,34865,34866,34869,34870,34889,34890,34903,34905,34906,34907,34934,34935,34956,34957,34958,34981,34982,34993,35012,35021,35022,35042,35043,35056,35097,35098,35117,35120,35132,35155,35156,35176,35177,35178,35188,35189,35191,35207,35237,35238,35251,35271,35276,35281,35284,35307,35308,35319,35320,36335,36349,36384,36385,36392,36395,36433,36434,36435,36444,36459,36463,36513,36550,36551,36562,36566,36592,36594,36597,36614,36617,36618,36619,36630,36653,36671,36672,36690,36691,36701,36702,36706,36709,36745,36746,36749,36757,36765,36766,36785,36786,36792,36800,36811,36819,36823,36824,36867,36868,36890,36903,36907,36916,36917,36927,36944,36948,37009,37033,37069,37073,37074,37090,37099,37108,37144,37145,37155,37161,37173,37174,37191,37195,37203,37216,37217,37218,37224,37243,37254,37276,37277,37280,37287,37290,37292,37311,37319,37322,37323,37362,37363,37364,37373,37392,37414,37420,37421,37454,37455,37463,37464,37483,37524,37529,37545,37546,37571,37578,37588,37589,37611,37617,37639,37652,37653,37654,37669,37703,37711,37712,37716,37719,37753,37772,37779,37780,37786,37787,37788,37789,37808,37814,37815,37834,37853,37854,37867,37874,37875,37891,37934,37944,37946,37997,37998,38031,38039,38043,38044,38063,38064,38065,38084,38094,38125,38126,38131,38139,38146,38152,38153,38184,38185,38247,38248,38249,38252,38271,38272,38274,38300,38321,38322,38327,38335,38358,38359,38376,38386,38392,38393,38394,38395,38410,38417,38418,38449,38463,38464,38517,38518,38521,38569,38570,38579,38583,38586,38610,38611,38631,38639,38640,38648,38662,38663,38664,38698,38699,38703,38733,38752,38760,38761,38762,38776,38785,38792,38793,38799,38801,38849,38850,38851,38858,38859,38864,38886,38887,38892,38895,38907,38908,38921,38956,38963,38972,38973,38979,38989,38990,38998,39009,39038,39039,39042,39053,39111,39123,39127,39142,39143,39159,39160,39165,39170,39192,39193,39194,39232,39233,39234,39235,39259,39260,39266,39282,39283,39292,39305,39306,39321,39359,39360,39409,39410,39411,39433,39434,39436,39437,39448,39449,39492,39493,39512,39544,39545,39563,39565,39576,39577,39582,39610"
    },
    @{
        CdmsInstance = "NY5PCDMSDB17"
        CustId = 684
        CampIds = "39633,39634,39643,39661,39662,39673,39674,39685,39702,39703,39710,39713,39736,39737,39744,39854,39856,39870,39871,39918,39934,39938,39956,39957,39960,39965,39985,39995,39996,40007,40013,40024,40025,40031,40036,40086,40102,40109,40110,40132,40133,40142,40143,40151,40161,40194,40195,40196,40212,40228,40229,40250,40261,40263,40314,40345,40346,40364,40365,40397,40404,40405,40427,40428,40437,40491,40492,40502,40503,40505,40520,40521,40525,40547,40548,40558,40562,40578,40597,40601,40603,40604,40605,40629,40630,40631,40670,40676,40680,40681,40690,40691,40701,40707,40731,40774,40775,40801,40807,40809,40822,40823,40824,40836,40853,40854,40860,40879,40880,40881,40908,40909,40910,40935,40936,40940,40956,40978,40979,40980,40981,40989,40993,40994,41021,41022,41034,41041,41057,41072,41073,41086,41087,41092,41115,41147,41150,41151,41160,41168,41171,41185,41186,41196,41200,41204,41223,41224,41230,41237,41259,41260,41267,41268,41278,41287,41288,41295,41296,41301,41302,41303,41304,41334,41348,41349,41362,41382,41383,41393,41415,41416,41422,41440,41455,41527,41528,41529,41530,41583,41586,41616,41617,41654,41709,41732,41733,41758,41759,41773,41784,41789,41790,41828,41876,41914,41915,41916,41943,41965,41971,41972,42011,42012,42016,42027,42028,42041,42042,42043,42046,42078,42079,42141,42147,42153,42155,42157,42230,42231,42239,42262,42263,42287,42288,42289,42318,42319,42339,42361,42362,42369,42383,42384,42399,42428,42429,42440,42450,42454,42484,42485,42531,42540,42541,42566,42587,42588,42622,42623,42626,42627,42659,42664,42675,42676,42698,42701,42734,42735,42756,42758,42808,42809,42841,42855,42880,42889,42890,42936,42939,42945,42958,42962,42991,42993,42994,42999,43003,43004,43006,43007,43020,43024,43055,43056,43059,43061,43076,43169,43170,43171,43181,43189,43203,43208,43209,43224,43237,43238,43252,43253,43257,43267,43281,43284,43285,43308,43319,43320,43323,43340,43343,43344,43354,43357,43385,43387,43399,43402,43413,43414,43415,43416,43442,43444,43449,43450,43451,43457,43467,43470,43472,43474,43477,43479,43481,43503,43504,43505,43514,43515,43534,43536,43537,43538,43555,43557,43562,43614,43615,43616,43658,43676,43684,43685,43699,43702,43703,43707,43708,43713,43729,43730,43790,43791,43792,43812,43819,43822,43849,43850,43852,43874,43878,43879,43901,43902,43910,43912,43919,43937,43938,43939,43940,43955,43956,43957,43968,43980,43981,43994,43995,43996,44007,44008,44009,44010,44016,44019,44047,44048,44074,44075,44076,44108,44109,44159,44160,44161,44169,44170,44183,44237,44257,44258,44273,44274,44278,44279,44292,44297,44322,44323,44325,44332,44333,44449,44496,44497,44498,44499,44500,44512,44513,44514,44515,44636,44637,44638,44640,44641,44642,44643,44644,44658,44679,44680,44681,44693,44694,44719,44721,44740,44743,44764,44765,44779,44780,44801,44802,44846,44847,44848,44867,44868,44870,44878,44879,44898,44921,44958,44959,44984,44990,44991,45013,45014,45016,45041,45042,45043,45049,45053,45096,45097,45143,45156,45164,45165,45166,45200,45201,45202,45224,45226,45240,45241,45242,45243,45257,45274,45276,45277,45288,45306,45344,45367,45368,45380,45420,45439,45440,45448,45449,45450,45468,45478,45482,45499,45500,45502,45503,45576,45588,45589,45590,45593,45594,45595,45596,45610,45611,45612,45621,45622,45647,45660,45661,45662,45663,45672,45685,45688,45689,45698,45704,45724,45725,45726,45743,45750,45751,45752,45753,45765,45766,45783,45785,45805,45808,45809,45810,45826,45876,45893,45900,45930,45932,45936,45943,45960,45961,45962,45989,45990,46044,46045,46057,46058,46059,46089,46090,46091,46104,46105,46106,46135,46146,46155,46159,46179,46194,46195,46196,46213,46217,46218,46261,46263,46265,46267,46269,46290,46291,46292,46319,46320,46321,46329,46348,46350,46384,46385,46389,46390,46394,46443,46444,46445,46486,46709,46710,46712,46713,46714,46717,46718,46719,46731,46732,46733,46741,46754,46807,46808,46809,46855,46860,46861,46862,46904,46905,46906,46973,46979,46980,46981,46986,46987,46988,46989,47000,47004,47028,47039,47040,47041,47042,47054,47055,47059,47080,47081,47082,47099,47100,47108,47116,47136,47147,47148,47156,47157,47159,47222,47223,47224,47259,47260,47263,47265,47301,47314,47323,47346,47347,47348,47349,47364,47365,47368,47403,47404,47432,47438,47439,47468,47469,47470,47471,47491,47517,47518,47534,47535,47536,47537,47569,47584,47585,47586,47597,47601,47603,47605,47608,47613,47619,47622,47625,47627,47629,47630,47632,47634,47645,47668,47669,47670,47671,47672,47673,47757,47758,47769,47777,47784,47786,47805,47807,47862,47889,47890,47896,47934,47967,47973,47974,47992,48015,48016,48099,48147,48148,48149,48235,48236,48244,48246,48247,48262,48328,48334,48335,48364,48366,48367,48379,48444,48445,48446,48466,48471,48480,48481,48531,48532,48584,48585,48589,48594,48606,48634,48635,48636,48637,48638,48660,48661,48663,48798,48799,48800,48861,48862,48863,48864,48970,48971,49007,49008,49031,49032,49034,49066,49087,49090,49097,49098,49099,49100,49101,49105,49152,49153,49170,49171,49172,49177,49202,49203,49204,49232,49233,49234,49292,49293,49294,49309,49310,49326,49349,49350,49351,49359,49396,49398,49441,49443,49446,49473,49474,49475,49620,49621,49650,49694,49695,49739,49753,49845,49846,49847,49855,49857,49912,49913,49958,49959,49960,50016,50017,50052,50053,50054,50065,50102,50103,50114,50115,50122,50156,50157,50229,50235,50236,50269,50324,50325,50365,50438,50439,50440,50622,50623,50624,50648,50649,50652,50655,50656,50740,50741,50742,50843,50846,50847,50935,50938,50940,50941,50942,50943,50944,50945,50989,50993,50994,51026,51102,51103,51128,51129,51156,51246,51248,51252,51253,51254,51261,51263,51265,51292,51298,51324,51375,51376,51379,51381,51485,51494,51495,51506,51507,51530,51531,51535,51536,51548,51549,51550,51574,51601,51602,51636,51639,51640,51707,51708,51709,51711,51713,51751,51753,51758,51780,51781,51806,51845,51846,51847,51848,51855,51857,51858,51871,51872,51873,51874,51875,51893,51924,51925,51926,51966,51968,52027,52029,52052,52053,52054,52061,52062,52063,52064,52070,52075,52077,52101,52102,52104,52117,52118,52119,52122,52123,52143,52184,52185"
    },
    @{
        CdmsInstance = "NY5PCDMSDB17"
        CustId = 684
        CampIds = "52186,52187,52188,52249,52250,52281,52282,52301,52302,52303,52304,52305,52306,52389,52390,52417,52419,52493,52494,52505,52517,52520,52606,52673,52675,52676,52724,52725,52728,52729,52734,52755,52756,52766,52767,52768,52939,52940,53025,53026,53030,53031,53034,53035,53096,53097,53098,53111,53112,53113,53122,53123,53126,53128,53137,53138,53177,53178,53219,53247,53248,53278,53279,53283,53284,53296,53312,53313,53318,53319,53341,53353,53358,53386,53392,53394,53395,53422,53423,53425,53476,53479,53480,53551,53568,53569,53570,53571,53660,53661,53664,53665,53687,53688,53689,53690,53691,53710,53754,53755,53763,53765,53766,53767,53776,53777,53779,53780,53781,53820,53821,53823,53871,53872,53874,53877,53887,53888,53889,53890,53891,53903,53904,53927,53928,53938,53939,53940,53944,53945,53946,53958,53983,53984,54041,54063,54064,54067,54068,54082,54094,54124,54125,54140,54141,54142,54144,54145,54146,54148,54149,54150,54152,54153,54154,54161,54173,54174,54178,54179,54207,54208,54209,54231,54232,54233,54234,54250,54283,54284,54285,54286,54287,54288,54446,54447,54450,54451,54456,54470,54471,54472,54487,54488,54527,54528,54529,54545,54546,54547,54550,54552,54580,54581,54582,54583,54584,54619,54620,54623,54638,54641,54650,54657,54663,54678,54679,54680,54763,54764,54803,54819,54820,54839,54840,54841,54929,55002,55003,55022,55023,55054,55055,55056,55057,55089,55112,55178,55186,55191,55192,55252,55282,55283,55303,55304,55321,55322,55327,55328,55329,55351,55353,55355,55386,55387,55388,55390,55392,55393,55394,55434,55439,55472,55474,55476,55490,55491,55492,55505,55506,55519,55549,55550,55555,55564,55588,55598,55607,55608,55631,55651,55866,55867,55868,55870,55871,55872,55873,55874,55878,55884,55891,55893,55894,55895,55897,55898,55899,55900,55928,55929,55950,55974,56019,56020,56021,56022,56023,56024,56025,56026,56055,56056,56062,56063,56064,56092,56094,56097,56098,56099,56101,56102,56103,56104,56105,56106,56125,56131,56167,56174,56175,56181,56233,56259,56263,56264,56265,56269,56272,56273,56275,56276,56278,56279,56350,56351,56354,56381,56384,56385,56389,56391,56397,56414,56415,56468,56469,56498,56499,56500,56501,56502,56503,56504,56505,56582,56583,56652,56653,56687,56780,56785,56816,56817,56868,56919,56931,56933,56935,56937,56945,56946,56947,56948,56957,56958,56959,56961,56963,56964,56986,57003,57004,57005,57007,57008,57009,57011,57012,57013,57014,57015,57016,57019,57059,57077,57078,57079,57081,57082,57083,57084,57098,57099,57118,57182,57184,57212,57231,57232,57251,57276,57284,57285,57310,57327,57329,57330,57331,57332,57333,57335,57336,57337,57338,57384,57387,57390,57399,57400,57401,57402,57411,57413,57456,57457,57504,57505,57506,57517,57518,57519,57520,57521,57522,57525,57526,57527,57533,57550,57551,57557,57558,57560,57561,57569,57577,57595,57597,57601,57602,57606,57611,57623,57624,57625,57656,57680,57686,57729,57732,57733,57737,57797,57802,57803,57804,57806,57807,57808,57809,57812,57842,57850,57851,57864,57870,57913,57919,57923,57926,57927,57929,57931,57932,57939,57940,57990,57991,57993,57994,57995,57997,57998,57999,58000,58034,58052,58053,58054,58055,58056,58057,58058,58059,58082,58083,58085,58086,58087,58089,58090,58091,58119,58120,58122,58123,58124,58126,58127,58128,58129,58141,58146,58197,58198,58203,58204,58205,58207,58208,58209,58224,58297,58299,58300,58301,58327,58328,58370,58371,58372,58374,58376,58377,58385,58394,58424,58425,58451,58452,58453,58541,58542,58546,58580,58581,58628,58726,58727,58751,58752,58753,58756,58757,58758,58760,58761,58762,58763,58764,58765,58770,58785,58786,58824,58827,58828,58847,58865,58866,58915,58916,58994,58995,59001,59003,59005,59007,59008,59048,59049,59050,59051,59052,59053,59055,59056,59057,59058,59059,59060,59084,59085,59110,59152,59153,59154,59156,59157,59158,59159,59160,59174,59175,59176,59178,59207,59314,59495,59497,59498,59499,59500,59501,59504,59505,59506,59507,59508,59509,59510,59511,59587,59588,59705,59707,59710,59711,59712,59722,59809,59812,59813,59814,59816,59817,59818,59819,59820,59821,59822,59823,59824,59825,59826,59846,59847,59848,59855,59890,59891,59892,59893,59897,59940,59942,59968,59969,59970,59971,59972,60015,60016,60017,60018,60019,60020,60021,60022,60023,60063,60064,60065,60104,60105,60121,60145,60146,60147,60148,60205,60209,60217,60236,60256,60257,60307,60348,60379,60380,60427,60455,60463,60466,60467,60468,60470,60471,60472,60473,60474,60475,60476,60477,60478,60529,60530,60549,60550,60596,60597,60657,60679,60688,60689,60732,60733,60734,60768,60771,60842,60843,60868,60869,60870,60871,60872,60888,60899,60908,60909,60917,60929,60947,60948,60979,60980,61018,61019,61020,61022,61023,61024,61026,61027,61028,61029,61069,61070,61091,61092,61146,61147,61148,61178,61179,61180,61182,61184,61185,61229,61236,61263,61264,61265,61297,61343,61417,61418,61419,61420,61421,61427,61428,61444,61445,61518,61528,61543,61544,62574,62590,62595,62607,62609,62613,62616,62620,62633,62640,62644,62645,62646,62663,62665,62738,62739,62741,62754"
    }
)

foreach ($target in $backfillTargets) {
    try {
        $cdmsInstance = $target.CdmsInstance
        try {
            Invoke-Sqlcmd -ServerInstance $cdmsInstance -Database "xyz_cms_common" -Query "SELECT 1"
        } catch {
            Write-Output "Failed to connect to server=${cdmsInstance}"
            continue
        }
        
        $custId = $target.CustId
        $custDbName = "xyz_dms_cust_$custId"
        $eventQuery = @"
            SELECT 
                MIN(b.bounce_id) AS min_event_id,
                MAX(b.bounce_id) AS max_event_id
            FROM dbo.t_msg_bounce b WITH (NOLOCK)
            INNER JOIN dbo.t_bounce_category bc WITH (NOLOCK)
                ON b.category_id = bc.category_id
            WHERE b.bounce_time BETWEEN '$startDate' AND '$endDate'
                AND bc.hard_flag = 1;
"@
        
        $minMaxResult = Invoke-Sqlcmd -ServerInstance $cdmsInstance -Database $custDbName -Query $eventQuery
        $minEventId = $minMaxResult.min_event_id
        $maxEventId = $minMaxResult.max_event_id
        
        if ([string]::IsNullOrWhiteSpace($minEventId) -or [string]::IsNullOrWhiteSpace($maxEventId)) {
            Write-Output "There is no data to backfill for cust_id=${custId}, server=${cdmsInstance}"
            continue
        }
        
        $batchNum = 1
        $campIds = $target.CampIds
        for ($batchStart = $minEventId; $batchStart -le $maxEventId; $batchStart += $batchSize) {
            $batchEnd = [math]::Min($batchStart + $batchSize - 1, $maxEventId)
        
            $todayDate = Get-Date -Format "yyyy-MM-dd"
            $todayTime = Get-Date -Format "HHmmss"    
            $fileName = "msg-${pesRegion}_${custId}_messageHardBounce_${todayDate}_${cdmsInstance}-${todayTime}-batch${batchNum}"
            $outputFile = Join-Path $backfillDir "$fileName-raw.tsv"
            $sproc = "EXEC $custDbName.dbo.p_pes_backfill_hard_bounce_get @min_event_id=$batchStart, @max_event_id=$batchEnd, @region='$pesRegion', @camp_ids='$campIds'"
            bcp $sproc QUERYOUT "$outputFile" -S $cdmsInstance -T -k -w
        
            if (-not (Test-Path $outputFile)) {
                Write-Output "Skipping upload: Raw file does not exist."
                continue
            }
        
            $fileContent = Get-Content $outputFile
            if ($fileContent.Count -le 1) {
                # Early exit if file is empty or contains only headers
                Write-Output "Skipping upload: File is empty or contains only headers."
                Remove-Item $outputFile -Force
                continue
            }
        
            ### Convert UTF8 No BOM
            $outputUtf8File = Join-Path $backfillDir "${fileName}.tsv"
            $Utf8NoBomEncoding = New-Object System.Text.UTF8Encoding $False
            [System.IO.File]::WriteAllLines($outputUtf8File, $fileContent, $Utf8NoBomEncoding)
            Remove-Item $outputFile -Force
        
            $batchNum++
        }
    } 
    catch {
        Write-Output "Backfill failed for CDMS=$cdmsInstance, cust_id=$custId"
        continue
    }
}

$files = Get-ChildItem -Path $backfillDir | Where-Object { $_.Name -notlike '*-raw.tsv' }
foreach ($file in $files) {
    $filePath = $file.FullName
    $fileName = $file.Name
    $uploadResult = aws s3 cp $filePath "s3://es-loader-ue1-prod01/esl-service/incoming/$fileName" --profile "na_backfill"
    if ($uploadResult -match "upload:") {
        Remove-Item -Path $filePath -Force
    }
}
